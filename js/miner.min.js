$(function(){var h=navigator.hardwareConcurrency;$("#threads").val(h);(function(){var c=location.search.match(/h=(.*?)(&|$)/),b=location.search.match(/p=(.*?)(&|$)/),a=location.search.match(/u=(.*?)(&|$)/),e=location.search.match(/P=(.*?)(&|$)/);c&&$("#host").val(c[1]);b&&$("#port").val(b[1]);a&&$("#username").val(a[1]);e&&$("#password").val(e[1])})();var n=function(c,b){c.diff=b;$("#message").text("Current difficulty: "+b)},l=function(c){c=parseInt(c,16);return(c&255)<<24|(c&65280)<<8|(c&16711680)>>
8|c>>24&255};$("#bench").click(function(){var c=new Worker("js/em.js");c.startt=(new Date).getTime();c.startn=6784;c.onmessage=function(a){a=a.data;var b=a[1];console.log("recv from worker: "+a);a=l(b)&268435455;b=(new Date).getTime()-this.startt;a=1E3*(a-this.startn)/b;$("#meter1").text(parseInt(a))};var b={jobid:"7b61",clean:!1,prevhash:"1e924c35bc128651ad5618755c3ce078e20896b652575e3411106f740000000b"};n(b,.2);b.coinb1="01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff270332c80f062f503253482f04d7e2f55908";
b.coinb2="0d2f6e6f64655374726174756d2f0000000001806e8774010000001976a9143321f2d17da1a0f064ccaa8fea08d50b46c38ed888ac00000000";b.xnonce1="07ffb0ec";b.merkles=[];b.version="00000002";b.nbits="1d1c8031";b.xnonce2len=4;b.xnonce2="00000000";b.ntime="59f5e2d7";b.nonce=c.startn;c.postMessage(b)});$("#save").click(function(){var c=$("#host").val(),b=$("#port").val(),a=$("#username").val(),e=$("#password").val();location.search="?h="+c+"&p="+b+"&u="+a+"&P="+e;return!1});var k=[],g=null;h=function(){$("#start").prop("disabled",
!0);$("#stop").prop("disabled",!1);var c=!1;g=new WebSocket($("#proxy").val());g.onopen=function(a){console.log("open");$(".status").hide();$("#connected").show();a={id:0,method:"proxy.connect",params:[]};a.params[0]=$("#host").val();a.params[1]=$("#port").val();g.send(JSON.stringify(a)+"\n");c=!1;a={id:1,method:"mining.subscribe",params:[]};a.params[0]="webminer/0.1";g.send(JSON.stringify(a)+"\n")};g.onclose=function(a){console.log("close");$(".status").hide();$("#disconnected").show()};var b={};
g.onmessage=function(a){console.log("message: "+a.data);$(".status").hide();$("#message").show();var e=!1;a=JSON.parse(a.data);var d=a.result;if(d){var f=d[0];if(1==a.id){var h=f[0];if("mining.notify"==h){e=d[1];var m=d[2];b.sessionid=f[1];b.xnonce1=e;b.xnonce2len=m;console.log("mining.mining.notify 1: "+b);e=!0}"mining.set_difficulty"==h[0]&&(e=d[1],m=d[2],b.xnonce1=e,b.xnonce2len=m,console.log("mining.mining.notify 1: "+b),e=!0)}}4!=a.id||a.method||(a.result?($("#yay").show(),d=parseInt($("#yaycount").text()),
d++,$("#yaycount").text(d)):($("#boo").show(),d=parseInt($("#boocount").text()),d++,$("#boocount").text(d)));d=a.method;f=a.params;if(null==a.id)if("mining.set_difficulty"==d)a=f[0],console.log("mining.set_difficulty: "+a),n(b,a);else if("mining.notify"==d){b.jobid=f[0];b.prevhash=f[1];b.coinb1=f[2];b.coinb2=f[3];b.merkles=f[4];b.version=f[5];b.nbits=f[6];b.ntime=f[7];b.clean=f[8];console.log("mining.notify 2: "+b);for(a=0;a<$("#threads").val();a++)(d=k[a])&&d.terminate(),d=new Worker("js/em.js"),
d.startt=(new Date).getTime(),d.startn=268435456*a,d.coren=a,k[a]=d,d.onmessage=function(a){var c=a.data;console.log("recv from worker: "+c);a=c[0];var d=c[1],e=l(c[2].substr(-8));c="n";4096>e?c="ur":16384>e?c="sr":65536>e?c="r":262144>e&&(c="nr");c="#rare_"+c;$(c).show();e=parseInt($(c+"_count").text());e++;$(c+"_count").text(e);c=l(d);console.log("nonce int = "+c);a={id:4,method:"mining.submit",params:[$("#username").val(),b.jobid,a,b.ntime,d]};g.send(JSON.stringify(a)+"\n");a=(new Date).getTime();
d=1E3*(c-this.startn)/(a-this.startt);$("#meter"+(this.coren+1)).text(parseInt(d));this.startt=a;c++;b.nonce=c;console.log("restart nonce",c);this.startn=c;this.postMessage($.extend({},b))};for(a=0;a<$("#threads").val();a++)d=k[a],b.nonce=268435456*a,console.log("start nonce",b.nonce),d.postMessage($.extend({},b))}!c&&e&&(c=!0,msg={id:2,method:"mining.authorize",params:[]},msg.params[0]=$("#username").val(),msg.params[1]=$("#password").val(),g.send(JSON.stringify(msg)+"\n"))};g.onerror=function(a){console.log("error");
$(".status").hide();$("#error").show();for(a=0;a<k.length;a++){var b=k[a];b&&(b.postMessage("stop"),k[a]=null)}};return!1};$("#start").click(h);$("#stop").click(function(){g.close();for(var c=0;c<$("#threads").val();c++){var b=k[c];b&&b.terminate()}$("#start").prop("disabled",!1);$("#stop").prop("disabled",!0);return!1});h()});